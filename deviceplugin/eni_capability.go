package deviceplugin

import (
	"fmt"
	"github.com/denverdino/aliyungo/ecs"
	"github.com/sirupsen/logrus"
	"k8s.io/apimachinery/pkg/util/wait"
	"strings"
	"time"
)

var DefaultEcsBackoff = wait.Backoff{
	Steps:    5,
	Duration: 500 * time.Millisecond,
	Jitter:   1.0,
}

func GetEniCapByInstanceType(instanceType string, ecsClient *ecs.Client, floatingRatio float64, shift int) (int, error) {
	eniCap := 0
	err := wait.ExponentialBackoff(DefaultEcsBackoff, func() (done bool, err error) {
		instanceTypeItems, err := ecsClient.DescribeInstanceTypesNew(&ecs.DescribeInstanceTypesArgs{
			InstanceTypeFamily: string([]rune(instanceType)[0:strings.LastIndex(instanceType, ".")]),
		})

		if err != nil {
			logrus.Warnf("error get instance info: %vï¼Œ retry...", err)
			return false, nil
		}

		for _, instanceTypeSpec := range instanceTypeItems {
			if instanceTypeSpec.InstanceTypeId == instanceType {
				eniCap = instanceTypeSpec.EniQuantity
				break
			}
		}

		if eniCap == 0 {
			logrus.Warnf("error get instance type info: %v", instanceType)
			return false, fmt.Errorf("error get instance type info: %v", instanceType)
		}
		return true, nil
	})
	if err != nil {
		logrus.Warnf("error get instance info from openapi: %v, err: %v", instanceType, err)
		if instanceEniCap, ok := ecsEniMatix[instanceType]; ok {
			eniCap = instanceEniCap
		} else {
			return 0, fmt.Errorf("error found eni capability, instance type: %s", instanceType)
		}
	}
	eniCap = int(floatingRatio*float64(eniCap)) + shift - 1
	if eniCap < 0 {
		eniCap = 0
	}
	return eniCap, nil
}

var ecsEniMatix = map[string]int{
	"ecs.t1.xsmall":           1,
	"ecs.t1.small":            1,
	"ecs.s2.small":            1,
	"ecs.s3.medium":           2,
	"ecs.c1.small":            2,
	"ecs.c2.medium":           2,
	"ecs.s1.small":            1,
	"ecs.s2.large":            1,
	"ecs.s3.large":            2,
	"ecs.c1.large":            2,
	"ecs.c2.large":            2,
	"ecs.s1.medium":           1,
	"ecs.s2.xlarge":           1,
	"ecs.m1.medium":           2,
	"ecs.m1.xlarge":           2,
	"ecs.c2.xlarge":           2,
	"ecs.s1.large":            1,
	"ecs.s2.2xlarge":          1,
	"ecs.m2.medium":           2,
	"ecs.m2.xlarge":           2,
	"ecs.x1.a.large":          1,
	"ecs.x1.a.xlarge":         1,
	"ecs.x1.a.2xlarge":        1,
	"ecs.x1.b.large":          1,
	"ecs.x1.b.xlarge":         1,
	"ecs.x1.b.2xlarge":        1,
	"ecs.x1.b.3xlarge":        1,
	"ecs.x1.c.xlarge":         1,
	"ecs.x1.c.2xlarge":        1,
	"ecs.x1.c.3xlarge":        1,
	"ecs.x1.c.large":          1,
	"ecs.x1.d.xlarge":         1,
	"ecs.x1.d.2xlarge":        1,
	"ecs.x1.d.3xlarge":        1,
	"ecs.x1.d.10xlarge":       1,
	"ecs.x1.d.large":          1,
	"ecs.x1.d.1.5xlarge":      1,
	"ecs.x1.e.3xlarge":        1,
	"ecs.x1.h.2xlarge":        1,
	"ecs.x1.h.3xlarge":        1,
	"ecs.n1.tiny":             1,
	"ecs.n1.small":            1,
	"ecs.n1.medium":           2,
	"ecs.n1.large":            2,
	"ecs.n1.xlarge":           2,
	"ecs.n1.3xlarge":          2,
	"ecs.n1.7xlarge":          2,
	"ecs.n2.small":            1,
	"ecs.n2.medium":           2,
	"ecs.n2.large":            2,
	"ecs.n2.xlarge":           2,
	"ecs.n2.3xlarge":          2,
	"ecs.n2.7xlarge":          2,
	"ecs.e3.small":            1,
	"ecs.e3.medium":           2,
	"ecs.e3.large":            2,
	"ecs.e3.xlarge":           2,
	"ecs.e3.3xlarge":          2,
	"ecs.e3.7xlarge":          2,
	"ecs.m1.large":            2,
	"ecs.s1.xsmall":           1,
	"ecs.s2.xsmall":           1,
	"ecs.s2.medium":           1,
	"ecs.m1.small":            2,
	"ecs.c1.medium":           2,
	"ecs.x1.c.7xlarge":        1,
	"ecs.x1.c.10xlarge":       1,
	"ecs.x1.a2.large":         1,
	"ecs.x1.a2.xlarge":        1,
	"ecs.x1.a2.3xlarge":       1,
	"ecs.x1.b2.3xlarge":       1,
	"ecs.x1.b4.xlarge":        1,
	"ecs.x1.b4.3xlarge":       1,
	"ecs.x1.b4.5xlarge":       1,
	"ecs.x1.c.8xlarge":        1,
	"ecs.x1.c.12xlarge":       1,
	"ecs.x1.a2.4xlarge":       1,
	"ecs.x1.b4.4xlarge":       1,
	"ecs.db.c4mhd8":           8,
	"ecs.db.c4m8d8":           8,
	"ecs.db.c2m8d4":           8,
	"ecs.db.c2m4d8":           8,
	"ecs.db.c2m4d4":           8,
	"ecs.db.c2m4d2":           8,
	"ecs.db.c1m4d2":           3,
	"ecs.db.c1m4d1":           3,
	"ecs.db.c2m2d4":           8,
	"ecs.db.c2m2d1":           8,
	"ecs.db.c1m2d4":           3,
	"ecs.db.c1m2d1":           3,
	"ecs.db.c1m1d2":           3,
	"ecs.db.c1m1d1":           3,
	"ecs.sn1.medium":          2,
	"ecs.sn2.medium":          2,
	"ecs.sn1.large":           3,
	"ecs.sn1.xlarge":          4,
	"ecs.sn1.3xlarge":         8,
	"ecs.sn1.7xlarge":         8,
	"ecs.sn2.large":           3,
	"ecs.sn2.xlarge":          4,
	"ecs.sn2.3xlarge":         8,
	"ecs.sn2.7xlarge":         8,
	"ecs.sn2.9xlarge":         8,
	"ecs.n4.small":            1,
	"ecs.n4.large":            1,
	"ecs.n4.xlarge":           2,
	"ecs.n4.2xlarge":          2,
	"ecs.n4.4xlarge":          2,
	"ecs.n4.8xlarge":          2,
	"ecs.mn4.small":           1,
	"ecs.mn4.large":           1,
	"ecs.mn4.xlarge":          2,
	"ecs.mn4.2xlarge":         3,
	"ecs.mn4.4xlarge":         8,
	"ecs.mn4.8xlarge":         8,
	"ecs.xn4.small":           1,
	"ecs.e4.large":            1,
	"ecs.e4.xlarge":           2,
	"ecs.e4.2xlarge":          3,
	"ecs.e4.4xlarge":          8,
	"ecs.gn3.2xlarge":         4,
	"ecs.sn1.13xlarge":        8,
	"ecs.sn2.13xlarge":        8,
	"ecs.e4.small":            1,
	"ecs.se1.large":           2,
	"ecs.se1.xlarge":          3,
	"ecs.se1.2xlarge":         4,
	"ecs.se1.4xlarge":         8,
	"ecs.se1.8xlarge":         8,
	"ecs.se1.14xlarge":        8,
	"ecs.ga1.4xlarge":         8,
	"ecs.ga1.8xlarge":         8,
	"ecs.ga1.14xlarge":        8,
	"ecs.gn4.8xlarge":         8,
	"ecs.gn4.14xlarge":        8,
	"ecs.i1.large":            2,
	"ecs.i1.xlarge":           3,
	"ecs.i1.2xlarge":          4,
	"ecs.i1.4xlarge":          8,
	"ecs.i1.8xlarge":          8,
	"ecs.i1.14xlarge":         8,
	"ecs.cm4.xlarge":          3,
	"ecs.cm4.2xlarge":         4,
	"ecs.cm4.4xlarge":         8,
	"ecs.ce4.xlarge":          3,
	"ecs.c4.xlarge":           3,
	"ecs.c4.2xlarge":          4,
	"ecs.c4.4xlarge":          8,
	"ecs.cm4.6xlarge":         8,
	"ecs.n5.large":            2,
	"ecs.n5.xlarge":           3,
	"ecs.n5.2xlarge":          4,
	"ecs.n5.4xlarge":          8,
	"ecs.n5.8xlarge":          8,
	"ecs.n5.16xlarge":         8,
	"ecs.sc1.4xlarge":         8,
	"ecs.d1.xlarge":           3,
	"ecs.d1.2xlarge":          4,
	"ecs.d1.4xlarge":          8,
	"ecs.d1.6xlarge":          8,
	"ecs.d1.8xlarge":          8,
	"ecs.d1.14xlarge":         8,
	"ecs.x1.i2.7xlarge":       8,
	"ecs.x1.i2.14xlarge":      8,
	"ecs.x1.i3.4xlarge":       8,
	"ecs.x1.i1.6xlarge":       8,
	"ecs.x1.i1.8xlarge":       8,
	"ecs.x1.i4.10xlarge":      8,
	"ecs.ga1.2xlarge":         4,
	"ecs.ga1.xlarge":          3,
	"ecs.sn1ne.large":         2,
	"ecs.sn1ne.xlarge":        3,
	"ecs.sn1ne.2xlarge":       4,
	"ecs.sn1ne.4xlarge":       8,
	"ecs.sn1ne.8xlarge":       8,
	"ecs.sn2ne.large":         2,
	"ecs.sn2ne.xlarge":        3,
	"ecs.sn2ne.2xlarge":       4,
	"ecs.sn2ne.4xlarge":       8,
	"ecs.sn2ne.8xlarge":       8,
	"ecs.sn2ne.14xlarge":      8,
	"ecs.se1ne.large":         2,
	"ecs.se1ne.xlarge":        3,
	"ecs.se1ne.2xlarge":       4,
	"ecs.se1ne.4xlarge":       8,
	"ecs.se1ne.8xlarge":       8,
	"ecs.se1ne.14xlarge":      8,
	"ecs.i1-c10d1.8xlarge":    8,
	"ecs.x1.i5.14xlarge":      8,
	"ecs.i1-c5d1.4xlarge":     8,
	"ecs.f1-c4f1.xlarge":      3,
	"ecs.f1-c8f1.2xlarge":     2,
	"ecs.f1-c16f1.4xlarge":    8,
	"ecs.f1-c4f1.2xlarge":     4,
	"ecs.f1-c8f1.4xlarge":     2,
	"ecs.gn5-c4g1.xlarge":     3,
	"ecs.gn5-c8g1.2xlarge":    4,
	"ecs.gn5-c4g1.2xlarge":    4,
	"ecs.gn5-c8g1.4xlarge":    8,
	"ecs.gn5-c8g1.8xlarge":    8,
	"ecs.gn5-c8g1.14xlarge":   8,
	"ecs.gn4-c4g1.xlarge":     3,
	"ecs.gn4-c8g1.2xlarge":    4,
	"ecs.gn4-c4g1.2xlarge":    4,
	"ecs.gn4-c8g1.4xlarge":    8,
	"ecs.d1ne.xlarge":         3,
	"ecs.d1ne.2xlarge":        4,
	"ecs.d1ne.4xlarge":        8,
	"ecs.d1ne.6xlarge":        8,
	"ecs.d1ne.8xlarge":        8,
	"ecs.d1ne.14xlarge":       8,
	"ecs.d1-c8d3.8xlarge":     8,
	"ecs.d1-c14d3.14xlarge":   8,
	"ecs.c5.large":            2,
	"ecs.c5.xlarge":           3,
	"ecs.c5.2xlarge":          4,
	"ecs.c5.4xlarge":          8,
	"ecs.c5.6xlarge":          8,
	"ecs.c5.8xlarge":          8,
	"ecs.c5.16xlarge":         8,
	"ecs.g5.large":            2,
	"ecs.g5.xlarge":           3,
	"ecs.g5.2xlarge":          4,
	"ecs.g5.4xlarge":          8,
	"ecs.g5.6xlarge":          8,
	"ecs.g5.8xlarge":          8,
	"ecs.g5.16xlarge":         8,
	"ecs.r5.large":            2,
	"ecs.r5.xlarge":           3,
	"ecs.r5.2xlarge":          4,
	"ecs.r5.4xlarge":          8,
	"ecs.r5.6xlarge":          8,
	"ecs.r5.8xlarge":          8,
	"ecs.r5.16xlarge":         8,
	"ecs.r5.22xlarge":         15,
	"ecs.hfc5.large":          2,
	"ecs.hfc5.xlarge":         3,
	"ecs.hfc5.2xlarge":        4,
	"ecs.hfc5.4xlarge":        8,
	"ecs.hfc5.6xlarge":        8,
	"ecs.hfc5.8xlarge":        8,
	"ecs.hfg5.large":          2,
	"ecs.hfg5.xlarge":         3,
	"ecs.hfg5.2xlarge":        4,
	"ecs.hfg5.4xlarge":        8,
	"ecs.hfg5.6xlarge":        8,
	"ecs.hfg5.8xlarge":        8,
	"ecs.hfg5.14xlarge":       8,
	"ecs.i2.large":            2,
	"ecs.i2.xlarge":           3,
	"ecs.i2.2xlarge":          4,
	"ecs.i2.4xlarge":          8,
	"ecs.i2.6xlarge":          8,
	"ecs.i2.8xlarge":          8,
	"ecs.i2.16xlarge":         8,
	"ecs.x1.i3.14xlarge":      8,
	"ecs.x1.i3.7xlarge":       8,
	"ecs.x1.i8.22xlarge":      2,
	"ecs.x1.i8.7xlarge":       2,
	"ecs.x1.i6.4xlarge":       2,
	"ecs.x1.i6.21xlarge":      2,
	"ecs.x1.i6.9xlarge":       2,
	"ecs.x1.i7.14xlarge":      8,
	"ecs.gn5-c28g1.7xlarge":   8,
	"ecs.gn5-c28g1.14xlarge":  8,
	"ecs.re4.20xlarge":        2,
	"ecs.re4.40xlarge":        2,
	"ecs.gn5i-c2g1.large":     2,
	"ecs.gn5i-c4g1.xlarge":    3,
	"ecs.gn5i-c8g1.2xlarge":   4,
	"ecs.gn5i-c16g1.4xlarge":  8,
	"ecs.gn5i-c28g1.14xlarge": 8,
	"ecs.gn5t.7xlarge":        8,
	"ecs.gn5t.14xlarge":       8,
	"ecs.t5-c1m1.large":       1,
	"ecs.t5-c1m1.xlarge":      2,
	"ecs.t5-c1m1.2xlarge":     2,
	"ecs.t5-c1m1.4xlarge":     2,
	"ecs.t5-c1m2.large":       1,
	"ecs.t5-c1m2.xlarge":      2,
	"ecs.t5-c1m2.2xlarge":     2,
	"ecs.t5-c1m2.4xlarge":     2,
	"ecs.t5-c1m4.large":       1,
	"ecs.t5-c1m4.xlarge":      2,
	"ecs.t5-c1m4.2xlarge":     2,
	"ecs.t5-lc2m1.nano":       1,
	"ecs.t5-lc1m1.small":      1,
	"ecs.t5-lc1m2.small":      1,
	"ecs.t5-lc1m2.large":      1,
	"ecs.t5-lc1m4.large":      1,
	"ecs.f1-c28f1.7xlarge":    2,
	"ecs.f1-c28f1.14xlarge":   2,
	"ecs.sccg5.24xlarge":      32,
	"ecs.scch5.16xlarge":      32,
	"ecs.sccgn5d.16xlarge":    2,
	"ecs.sccgn5.16xlarge":     2,
	"ecs.ebmg5.24xlarge":      32,
	"ecs.ebmr5.24xlarge":      32,
	"ecs.f2-c8f1.2xlarge":     2,
	"ecs.f2-c28f1.7xlarge":    2,
	"ecs.f2-c8f1.4xlarge":     2,
	"ecs.f2-c28f1.14xlarge":   2,
	"ecs.gn5i-c40g1.10xlarge": 8,
	"ecs.gn5i-c48g1.12xlarge": 2,
	"ecs.ebmr5.2xlarge":       6,
	"ecs.ebmr4.4xlarge":       12,
	"ecs.ebmg4.8xlarge":       12,
	"ecs.ebmg4.16xlarge":      12,
	"ecs.ebma1.24xlarge":      1,
	"ecs.gn6p-c8g1.2xlarge":   2,
	"ecs.gn6p-c8g1.4xlarge":   2,
	"ecs.gn6p-c8g1.8xlarge":   2,
	"ecs.gn6p-c8g1.16xlarge":  2,
	"ecs.gn5i-c16g1.8xlarge":  8,
	"ecs.sn1ne.3xlarge":       6,
	"ecs.sn1ne.6xlarge":       4,
	"ecs.sn2ne.3xlarge":       6,
	"ecs.sn2ne.6xlarge":       4,
	"ecs.se1ne.3xlarge":       6,
	"ecs.se1ne.6xlarge":       4,
	"ecs.c4.3xlarge":          6,
	"ecs.cm4.3xlarge":         6,
	"ecs.ce4.2xlarge":         4,
	"ecs.c5.3xlarge":          6,
	"ecs.hfc5.3xlarge":        6,
	"ecs.g5.3xlarge":          6,
	"ecs.g5.22xlarge":         15,
	"ecs.hfg5.3xlarge":        6,
	"ecs.r5.3xlarge":          6,
	"ecs.i1.3xlarge":          6,
	"ecs.i1.6xlarge":          4,
	"ecs.d1.3xlarge":          6,
	"ecs.g5se.large":          1,
	"ecs.g5se.xlarge":         3,
	"ecs.g5se.2xlarge":        3,
	"ecs.g5se.4xlarge":        8,
	"ecs.g5se.6xlarge":        8,
	"ecs.g5se.8xlarge":        8,
	"ecs.g5se.16xlarge":       8,
	"ecs.g5se.18xlarge":       8,
	"ecs.gn5i-c12g1.6xlarge":  8,
	"ecs.gn5t.4xlarge":        2,
	"ecs.ebmgn5t.16xlarge":    1,
	"ecs.sccgn5t.16xlarge":    1,
	"ecs.sccgn6.24xlarge":     1,
	"ecs.ebmgn5.16xlarge":     1,
	"ecs.ebmgn5i.16xlarge":    1,
	"ecs.ebmhfg5.2xlarge":     6,
	"ecs.ebmhfg4.4xlarge":     12,
	"ecs.ebmc4.8xlarge":       12,
	"ecs.ic5.large":           2,
	"ecs.ic5.xlarge":          3,
	"ecs.ic5.2xlarge":         4,
	"ecs.ic5.3xlarge":         6,
	"ecs.ic5.4xlarge":         8,
	"ecs.ic5.6xlarge":         8,
	"ecs.ic5.8xlarge":         8,
	"ecs.ic5.16xlarge":        8,
	"ecs.gn5d-c8g1.8xlarge":   8,
	"ecs.ebmhfg5.16xlarge":    32,
	"ecs.gn5-c48g1.12xlarge":  8,
	"ecs.ebmgn5i.24xlarge":    31,
	"ecs.ebmi2.24xlarge":      31,
	"ecs.d1ne-c8d3.8xlarge":   8,
	"ecs.d1ne-c14d3.14xlarge": 8,
	"ecs.c5-618.22xlarge":     32,
	"ecs.g5-618.22xlarge":     32,
	"ecs.f3-c4f1.xlarge":      3,
	"ecs.f3-c8f1.2xlarge":     4,
	"ecs.f3-c12f1.3xlarge":    6,
	"ecs.f3-c16f1.4xlarge":    8,
	"ecs.f3-c24f1.6xlarge":    8,
	"ecs.f3-c32f1.8xlarge":    8,
	"ecs.f3-c40f1.10xlarge":   8,
	"ecs.f3-c6f1.3xlarge":     6,
	"ecs.f3-c8f1.4xlarge":     8,
	"ecs.f3-c12f1.6xlarge":    8,
	"ecs.f3-c16f1.8xlarge":    8,
	"ecs.f3-c32f1.16xlarge":   8,
	"ecs.f3-c8f1.8xarge":      8,
	"ecs.f3-c16f1.16xlarge":   8,
	"ecs.ebmgn5t.10xlarge":    32,
	"ecs.gn6v-c8g1.2xlarge":   4,
	"ecs.gn6v-c8g1.4xlarge":   8,
	"ecs.gn6v-c8g1.8xlarge":   8,
	"ecs.gn6v-c8g1.16xlarge":  8,
	"ecs.g5-618.21xlarge":     32,
	"ecs.c5-618e.22xlarge":    32,
	"ecs.g5-618e.22xlarge":    32,
	"ecs.g5-618e.21xlarge":    32,
	"ecs.ebmi3.24xlarge":      32,
	"ecs.re5.15xlarge":        8,
	"ecs.re5.30xlarge":        15,
	"ecs.re5.45xlarge":        15,
	"ecs.g5-618e.16xlarge":    8,
	"ecs.g5-618e.6xlarge":     8,
	"ecs.gn5e-c11g1.3xlarge":  6,
	"ecs.gn5e-c11g1.5xlarge":  8,
	"ecs.gn5e-c11g1.11xlarge": 8,
	"ecs.gn5e-c11g1.22xlarge": 8,
	"ecs.ebmg5ne.24xlarge":    1,
}